name: Update README Age
on:
  schedule:
    - cron: '0 0 30 10 *'
  workflow_dispatch:

jobs:
  update-age:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get birth date from README
        id: get_birth_date
        run: |
          BIRTH_DATE=$(grep -oP "(?<=BIRTH_DATE:)[0-9]{4}-[0-9]{2}-[0-9]{2}" README.md || true)
          if [ -z "$BIRTH_DATE" ]; then
            echo "‚ùå Data de nascimento n√£o encontrada no README.md."
            exit 1
          fi
          echo "‚úÖ Data de nascimento encontrada: $BIRTH_DATE"
          echo "birth_date=$BIRTH_DATE" >> $GITHUB_OUTPUT

      - name: Calculate age from birth date
        id: calculate_age
        run: |
          BIRTH_DATE=${{ steps.get_birth_date.outputs.birth_date }}
          TODAY=$(date +%Y-%m-%d)

          BIRTH_YEAR=$(date -d "$BIRTH_DATE" +%Y)
          BIRTH_MONTH=$(date -d "$BIRTH_DATE" +%m)
          BIRTH_DAY=$(date -d "$BIRTH_DATE" +%d)

          CURRENT_YEAR=$(date +%Y)
          CURRENT_MONTH=$(date +%m)
          CURRENT_DAY=$(date +%d)

          AGE=$((CURRENT_YEAR - BIRTH_YEAR))
          if [ $CURRENT_MONTH -lt $BIRTH_MONTH ] || { [ $CURRENT_MONTH -eq $BIRTH_MONTH ] && [ $CURRENT_DAY -lt $BIRTH_DAY ]; }; then
            AGE=$((AGE - 1))
          fi

          echo "üéÇ Idade calculada: $AGE"
          echo "calculated_age=$AGE" >> $GITHUB_OUTPUT

      - name: Update README with new age
        run: |
          NEW_AGE=${{ steps.calculate_age.outputs.calculated_age }}
          sed -E -i "s/(- ü§ì \*\*Minha idade:\*\*\s*)[0-9]+/\1${NEW_AGE}/" README.md

          if git diff --quiet README.md; then
            echo "‚ÑπÔ∏è Nenhuma mudan√ßa na idade. Commit n√£o necess√°rio."
          else
            echo "‚úÖ Idade atualizada para ${NEW_AGE}. Fazendo commit..."
            git config user.name "github-actions"
            git config user.email "github-actions@github.com"
            git add README.md
            git commit -m "Parab√©ns pelos ${NEW_AGE} anos üéâ"
            git push
          fi
