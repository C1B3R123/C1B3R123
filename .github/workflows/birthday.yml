name: Update Age

on:
  schedule:
    - cron: "0 0 30 10 *"
  workflow_dispatch:

jobs:
  update_age:
    name: Update Age on Birthday
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Calculate Age and Update README
        run: |
          set -x
          README_FILE="README.md"
          SEARCH_PATTERN="^- Programador com \("
          LINE_NUM=$(grep -n -m 1 -E "$SEARCH_PATTERN" $README_FILE | cut -d : -f 1)

          if [ -z "$LINE_NUM" ]; then
            echo "Erro: A linha com o padr√£o '$SEARCH_PATTERN' n√£o foi encontrada em $README_FILE."
            echo "Por favor, certifique-se de que seu README.md cont√©m uma linha no formato '- Programador com (XX anos) de idade'."
            exit 1
          else
            echo "Linha encontrada no n√∫mero: $LINE_NUM"
            CURRENT_AGE=$(grep -oP "$SEARCH_PATTERN\([0-9]+\)" $README_FILE | grep -oP "[0-9]+")
            echo "Idade atual encontrada: $CURRENT_AGE"
            NEW_AGE=$((CURRENT_AGE + 1))
            echo "Nova idade calculada: $NEW_AGE"
            if [[ "$RUNNER_OS" == "macOS" ]]; then
              sed -i '' "${LINE_NUM}s/([0-9]\+)/(${NEW_AGE})/" $README_FILE
            else
              sed -i "${LINE_NUM}s/([0-9]\+)/(${NEW_AGE})/" $README_FILE
            fi
            echo "README.md atualizado com idade: ${NEW_AGE}"
          fi

      - name: Commit and Push Changes
        run: |
          if git diff --quiet $README_FILE; then
            echo "Nenhuma altera√ß√£o no README.md. Pulando commit e push."
          else
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add $README_FILE
            git commit -m "Feliz Anivers√°rio! Idade atualizada para ${NEW_AGE} anos üéâ"
            git push origin main
          fi
