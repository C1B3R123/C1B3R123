name: Update Age

on:
  schedule:
    - cron: "0 0 30 10 *"
  workflow_dispatch:

jobs:
  update_age:
    name: Update Age on Birthday
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Calculate Age and Update README
        run: |
          BIRTH_YEAR=2006
          BIRTH_MONTH=10
          BIRTH_DAY=30

          CURRENT_YEAR=$(date +%Y)
          CURRENT_MONTH=$(date +%m)
          CURRENT_DAY=$(date +%d)

          AGE=$((CURRENT_YEAR - BIRTH_YEAR))

          if (( 10#$CURRENT_MONTH < 10#$BIRTH_MONTH )) || (( 10#$CURRENT_MONTH == 10#$BIRTH_MONTH && 10#$CURRENT_DAY < 10#$BIRTH_DAY )); then
              AGE=$((AGE - 1))
          fi

          NEW_AGE=$AGE

          README_FILE="README.md"

          SEARCH_PATTERN="Programador com.*anos de idade"

          LINE_NUM=$(grep -n -m 1 -i -E "$SEARCH_PATTERN" $README_FILE | cut -d : -f 1)

          if [ -z "$LINE_NUM" ]; then
            echo "Erro: A linha contendo 'Programador com' e 'anos de idade' nÃ£o foi encontrada em $README_FILE."
            echo "Por favor, certifique-se de que seu README.md contÃ©m uma linha com este texto."
            exit 1
          else
            echo "Linha encontrada no nÃºmero: $LINE_NUM"

            NEW_LINE="- ðŸ¤“ Programador com (${NEW_AGE} anos) de idade"
            echo "Nova linha a ser inserida: '$NEW_LINE'"

            if [[ "$RUNNER_OS" == "macOS" ]]; then
              sed -i '' "${LINE_NUM}s|.*|$NEW_LINE|" $README_FILE
            else
              sed -i "${LINE_NUM}s|.*|$NEW_LINE|" $README_FILE
            fi
            echo "README.md atualizado com idade: ${NEW_AGE}"
          fi

      - name: Commit and Push Changes
        run: |
          if git diff --quiet $README_FILE; then
            echo "Nenhuma alteraÃ§Ã£o no README.md. Pulando commit e push."
          else
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add $README_FILE
            git commit -m "Feliz AniversÃ¡rio! Idade atualizada para ${NEW_AGE} anos ðŸŽ‰"
            git push origin main
          fi
