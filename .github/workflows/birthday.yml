name: Update Age

on:
  schedule:
    # Sim, Minha data de nascimento √© (30/10/2006), mude esta data para que 
    - cron: "0 0 30 10 *"
  workflow_dispatch:

jobs:
  update_age:
    name: Calculate and Update Age on Birthday
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Calculate Age and Update README
        run: |
          BIRTH_YEAR=2006
          CURRENT_YEAR=$(date +%Y)
          NEW_AGE=$((CURRENT_YEAR - BIRTH_YEAR))
          README_FILE="README.md"
          NEW_LINE="- Programador com (${NEW_AGE} anos) de idade"
          SEARCH_PATTERN="^- Programador com \("
          LINE_NUM=$(grep -n -m 1 -E "$SEARCH_PATTERN" $README_FILE | cut -d : -f 1)
          if [ -z "$LINE_NUM" ]; then
            ORIGINAL_BIRTH_LINE="- üéÇ **Nascimento:** 30 de Outubro de 2006"
            LINE_NUM=$(grep -n -m 1 "$ORIGINAL_BIRTH_LINE" $README_FILE | cut -d : -f 1)
            if [ -z "$LINE_NUM" ]; then
              echo "Erro: Nenhuma das linhas esperadas foi encontrada em $README_FILE. Verifique o README.md e os padr√µes de busca no workflow."
              exit 1
            else
              echo "Linha original da data de nascimento encontrada no n√∫mero: $LINE_NUM"
              if [[ "$RUNNER_OS" == "macOS" ]]; then
                sed -i '' "${LINE_NUM}s|^.*|$NEW_LINE|" $README_FILE
              else
                sed -i "${LINE_NUM}s|^.*|$NEW_LINE|" $README_FILE
              fi
              echo "README.md atualizado com idade: ${NEW_AGE}"
            fi
          else
            echo "Linha 'Programador com...' encontrada no n√∫mero: $LINE_NUM"
            if [[ "$RUNNER_OS" == "macOS" ]]; then
              sed -i '' "${LINE_NUM}s|^.*|$NEW_LINE|" $README_FILE
            else
              sed -i "${LINE_NUM}s|^.*|$NEW_LINE|" $README_FILE
            fi
            echo "README.md atualizado com idade: ${NEW_AGE}"
          fi


      - name: Commit and Push Changes
        run: |
          # Verifica se h√° altera√ß√µes para commitar
          if git diff --quiet $README_FILE; then
            echo "Nenhuma altera√ß√£o no README.md. Pulando commit e push."
          else
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add $README_FILE
            git commit -m "Feliz Anivers√°rio! Idade atualizada para ${NEW_AGE} anosüéâ, lembre-se do que importa e seja feliz em sua vida. "
            git push origin main
          fi
